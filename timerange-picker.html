<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../bower_components/paper-time-picker/paper-time-picker.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">

<script src='../../bower_components/moment/min/moment.min.js'></script>

<!--
@demo demo/index.html
@hero hero.svg
-->

<dom-module id="timerange-picker">
    <template>
      <style>
        :host {
          display: flex;
          box-sizing: border-box;
          align-items: center;
          justify-content: center;
          margin-bottom: 4px;
        }
        paper-button#currenttimerange {
          background-color: #eee;
          text-transform: none;
        }
        paper-icon-button {
          padding: 0.7em 0.57em;
        }
        paper-icon-button[disabled] {
          opacity: 0.32;
        }
        .time-input paper-icon-button {
          align-self: flex-end;
        }
        .time-input {
          vertical-align: baseline;
        }
        .buttons {
          justify-content: flex-end;
        }
        #timerange {
          margin-right: 16px;
        }
        #quickrange {
          margin: 0 16px 32px 16px;
        }
        paper-dialog h3 {
          margin-top: 0;
          margin-bottom: 0;
        }
        hr {
          margin: 0;
        }
        paper-item {
          padding: 4px;
          font-size: 14px;
          min-height: auto;
          cursor: pointer;
        }
        paper-icon-button, paper-icon-button {
            display: block;
        }
      </style>
      <paper-icon-button on-tap="minusDuration" icon="icons:chevron-left"></paper-icon-button>
      <paper-button id="currenttimerange" toggles active="{{mainDialogOpen}}" on-tap="_setInterval">{{durationText}}</paper-button>
      <paper-icon-button id="plusButton" disabled="true" on-tap="plusDuration" icon="icons:chevron-right"></paper-icon-button>
      <paper-dialog opened="{{mainDialogOpen}}" id="dialog" modal class="paper-time-picker-dialog">
          <div class="layout horizontal">
            <div id="timerange">
                <h3>Time Range</h3>
                <div class="layout horizontal time-input">
                    <paper-input class="flex" id="from" label="From" value="{{localFrom}}" on-tap="clearSelectedButton"></paper-input>
                    <paper-icon-button class="from" toggles active="{{fromDialogOpen}}" icon="editor:insert-invitation"></paper-icon-button>
                </div>
                <div class="layout horizontal time-input">
                    <paper-input class="flex" id="to" label="To" value="{{localTo}}" on-tap="clearSelectedButton"></paper-input>
                    <paper-icon-button class="to" toggles active="{{toDialogOpen}}" icon="editor:insert-invitation"></paper-icon-button>
                </div>
                <paper-dropdown-menu id="refreshIntervalMenu" disabled$="{{_disableDropdown(localTo)}}" label="auto refresh" placeholder="off">
                  <paper-menu class="dropdown-content" selected="{{dropdownIntervalSelection}}" attr-for-selected="data-value" >
                    <paper-item data-value=0>off</paper-item>
                    <paper-item data-value=10000>every 10sec</paper-item>
                    <paper-item data-value=60000>every 1min</paper-item>
                    <paper-item data-value=600000>every 10min</paper-item>
                  </paper-menu>
                </paper-dropdown-menu>
            </div>
            <div id="quickrange">
                <h3>Quick Ranges</h3>
                <div id="listbox" role="listbox">
                    <template is="dom-repeat" items="[[lastxDate]]" as="item">
                        <paper-item id="range" class$="range-button" from$="[[item.from]]" to$="[[item.to]]" type$="[[item.type]]" on-tap="computeDuration">[[item.text]]</paper-item>
                    </template>
                </div>
            </div>
          </div>
          <hr/>
          <div class="layout horizontal buttons">
              <paper-button dialog-dismiss on-tap="_resetInterval">Cancel</paper-button>
              <paper-button dialog-confirm on-tap="addNewDate">Apply</paper-button>
          </div>
      </paper-dialog>
      <paper-dialog id="datetime" opened="{{fromDialogOpen}}">
          <h2>Select from datetime</h2>
          <div>
              <paper-date-picker id="pickDateFrom" class="date-button"></paper-date-picker>
              <paper-time-picker id="pickTimeFrom" class="time-button"></paper-time-picker>
          </div>
          <div class="pick-buttons">
              <paper-button dialog-confirm on-tap="applyFrom">Apply</paper-button>
              <paper-button dialog-dismiss>Cancel</paper-button>
          </div>
      </paper-dialog>
      <paper-dialog id="datetime" opened="{{toDialogOpen}}">
          <h2>Select to datetime</h2>
          <div>
              <paper-date-picker id="pickDateTo" class="date-button"></paper-date-picker>
              <paper-time-picker id="pickTimeTo" class="time-button"></paper-time-picker>
          </div>
          <div class="pick-buttons">
              <paper-button dialog-confirm on-tap="applyTo">Apply</paper-button>
              <paper-button dialog-dismiss>Cancel</paper-button>
          </div>
      </paper-dialog>
    </template>
    <script>
        Polymer({
            is: 'timerange-picker',

            properties: {
                mainDialogOpen: Boolean,
                fromDialogOpen: Boolean,
                toDialogOpen: Boolean,
                onApply: Boolean,
                lastxDate: Array,
                diff: {
                    type: Number,
                    value: 600000
                },
                endOfDiff: {
                    type: Date
                },
                //local values are used so as to not trigger any outside-element functions that are trigger from not localized ones.
                localFrom: {
                    type: String
                },
                localTo: {
                    type: String,
                    observer:"_dropdownReset"
                },
                localRefresh: {
                    type: Number,
                    value: 0
                },
                from: {
                    type: String,
                    notify: true,
                    observer: '_initTime'
                },
                to: {
                    type: String,
                    notify: true,
                    observer: '_initTime'
                },
                timeSpan: {
                    type: Number,
                    notify: true
                },
                durationText: {
                    type: String,
                    computed: '_computeDurationText(localFrom, localTo)'
                },
                refreshInterval: {
                    type: Number,
                    notify: true
                }
            },
            _dropdownReset:function(localTo){
                if(this.localTo!="now")
                  this._clearInterval();
            },
            _disableDropdown: function(val) {
                if (val == 'now') {
                    return false;
                } else {
                    return true;
                }
            },
            _clearInterval: function() {
                this.dropdownIntervalSelection = 0;
                this.refreshInterval = 0;
            },
            _setInterval: function() {
                this.dropdownIntervalSelection = this.refreshInterval;
                this.localRefresh = this.refreshInterval;
                this.set('refreshInterval', 0);
            },
            _resetInterval: function() {
                this.dropdownIntervalSelection = this.localRefresh;
                this.refreshInterval = this.localRefresh;
            },
            ready: function() {
                this.endOfDiff = new Date();
                this.lastxDate = [{
                    from: 5,
                    to: "now",
                    type: "minutes",
                    text: "Last 5 minutes"
                }, {
                    from: 30,
                    to: "now",
                    type: "minutes",
                    text: "Last 30 minutes"
                }, {
                    from: 1,
                    to: "now",
                    type: "hour",
                    text: "Last 1 hour"
                }, {
                    from: 3,
                    to: "now",
                    type: "hours",
                    text: "Last 3 hours"
                }, {
                    from: 7,
                    to: "now",
                    type: "days",
                    text: "Last 7 days"
                }, {
                    from: 30,
                    to: "now",
                    type: "days",
                    text: "Last 30 days"
                }, {
                    from: 1,
                    to: "now",
                    type: "year",
                    text: "Last 1 year"
                }];
            },
            _computeDurationText: function(from, to) {
                if (to == 'now' && typeof from === 'string' && from.search("/") == -1) {
                    var digits = parseInt(from.match(/\d+/g));
                    var unit;
                    if (from.search("min") > -1) {
                        unit = "minute" + this.numberEnding(digits);
                    } else if (from.search("d") > -1) {
                        unit = "day" + this.numberEnding(digits);
                    } else if (from.search("y") > -1) {
                        unit = "year" + this.numberEnding(digits);
                    } else if (from.search("month") > -1) {
                        unit = "month" + this.numberEnding(digits);
                    } else if (from.search("h") > -1) {
                        unit = "hour" + this.numberEnding(digits);
                    }
                    return "Last " + digits + " " + unit;
                } else if (to == 'now' && from.search("/") > -1) {
                    var seconds = Math.floor(new Date().getTime() / 1000) - Math.floor(new Date(from).getTime() / 1000);
                    var numyears = Math.floor(seconds / 31536000);
                    var numdays = Math.floor((seconds % 31536000) / 86400);
                    var numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);
                    var numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);
                    var numseconds = (((seconds % 31536000) % 86400) % 3600) % 60;
                    var text = "";
                    //we have to check which value we are going to display in order to calc the ending "s"
                    if (numyears > 0) {
                        text += numyears + " year" + this.numberEnding(numyears);
                    }
                    if (numdays > 0) {
                        text += numdays + " day" + this.numberEnding(numdays);
                    }
                    if (numhours > 0) {
                        text += numhours + " hour" + this.numberEnding(numhours);
                    }
                    if (numminutes > 0) {
                        text += numminutes + " minute" + this.numberEnding(numminutes);
                    }
                    return "Last " + text;
                } else {
                    return from + " - " + to;
                }
            },
            numberEnding: function(number) {
                return (number > 1) ? 's' : '';
            },
            _initTime: function(newValue, oldValue) {
                if (this.localTo == null || this.localTo == "") {
                    this.localTo = this.to;
                    this.localFrom = this.from;
                }
                if (oldValue == null) {
                    //in case we got timestamps
                    if (typeof newValue != 'string') {
                        if (this.from == newValue) {
                            this.from = new Date(newValue);
                        } else {
                            this.to = new Date(newValue);
                        }
                    } else { //in case we got relative time
                        var ret = newValue.replace('now-', '-');
                        if (ret.search('min') == -1 && ret.search('month') == -1)
                            ret = ret.replace('m', 'min');

                        if (this.from == newValue) {
                            this.from = ret;
                        } else {
                            this.to = ret;
                        }
                    }
                }
            },
            applyFrom: function() {
                var dateFrom = this.querySelector('#pickDateFrom'),
                    timeFrom = this.querySelector('#pickTimeFrom');
                this.localFrom = moment(dateFrom.date).format('MM/DD/YYYY');
                this.localFrom += " " + moment(timeFrom.time.toString(), "hh:mm A").format('HH:mm');
            },

            applyTo: function() {
                var dateTo = this.querySelector('#pickDateTo'),
                    timeTo = this.querySelector('#pickTimeTo');
                this.localTo = moment(dateTo.date).format('MM/DD/YYYY');
                this.localTo += " " + moment(timeTo.time.toString(), "hh:mm A").format('HH:mm');
                if (this.localTo != "now" || this.localTo != Math.floor(new Date().getTime() / 1000)) {
                    this.dropdownIntervalSelection = 0;
                }
            },

            computeDuration: function(e) {
                var el = e.srcElement;
                var diff = 0;
                var prevEl = this.querySelector('.range-button[selected="true"]');
                if (prevEl)
                    prevEl.setAttribute("selected", false);
                el.setAttribute("selected", true);
                var from = el.attributes.from.value;
                var to = el.attributes.to.value;
                var val = el.attributes.type.value;

                var newDate = new Date();
                switch (val) {
                    case "days":
                        this.localFrom = -from + "d";
                        this.diff = from * 86400000;
                        break;
                    case "hour":
                    case "hours":
                        this.localFrom = -from + "h";
                        this.diff = from * 3600000;
                        break;
                    case "year":
                        this.localFrom = -from + "y";
                        this.diff = from * 31556952000;
                        break;
                    case "minutes":
                        this.localFrom = -from + "min";
                        this.diff = from * 60000;
                        break;
                }
                console.log(this.localFrom);
                this.localTo = "now";
                this.querySelector('#plusButton').setAttribute("disabled", "true");
            },

            minusDuration: function() {
                this._clearInterval();
                var diff, from, to;
                if (typeof this.from === 'string') {
                    from = this._relativetoTimestamp(this.from, "from");
                } else {
                    from = this.from;
                }
                if (typeof this.to === 'string' && this.to != 'now') {
                    to = this._relativetoTimestamp(this.to, "to");
                } else {
                    to = this.to;
                }
                if (this.localTo == "now" || this.to == "now") {
                    diff = this.diff;
                    to = Math.floor(new Date().getTime() / 1000);
                    from = to - this.diff / 1000;
                } else {
                    diff = to * 1000 - from * 1000;
                    this.diff = diff;
                }
                this.querySelector('#plusButton').removeAttribute("disabled");
                var start = new Date((from * 1000) - diff);
                var end = new Date((to * 1000) - diff);
                this.localTo = moment(end).format('MM/DD/YYYY HH:mm');
                this.localFrom = moment(start).format('MM/DD/YYYY HH:mm');
                this.to = Math.floor(end.getTime() / 1000);
                this.from = Math.floor(start.getTime() / 1000);
                console.log(this.localFrom, this.localTo)
            },

            plusDuration: function() {
                this._clearInterval();
                var diff, from, to;
                if (typeof this.from === 'string') {
                  //we need to calculate the timestamp in case e.g from=-2d and to=1d and he hits plus duration
                    from = this._relativetoTimestamp(this.from, "from");
                } else {
                    from = this.from;
                }
                if (typeof this.to === 'string' && this.to != 'now') {
                    to = this._relativetoTimestamp(this.to, "to");
                } else {
                    to = this.to;
                }
                diff = to * 1000 - from * 1000;
                this.diff = diff;
                var start = new Date((from * 1000 + diff));
                var end = new Date((to * 1000 + diff));
                if (new Date((to * 1000 + diff * 2)) >= new Date()) {
                    this.querySelector('#plusButton').setAttribute("disabled", "true");
                    this.to = "now"
                    this.localTo = "now"
                } else {
                    this.localTo = moment(end).format('MM/DD/YYYY HH:mm');
                }
                this.localFrom = moment(start).format('MM/DD/YYYY HH:mm');
                this.to = Math.floor(end.getTime() / 1000);
                this.from = Math.floor(start.getTime() / 1000);
            },

            _relativetoTimestamp: function(relative, who) {
                var timestamp = relative;
                //we need to calculate what timestamp is "now" so we can calculate later the diff so that we can add/subtract it to move in time
                if (who == "to" || this.localTo == "now" ||(typeof relative==='string' && relative.search("/")==-1)) {
                    var now = Math.floor(new Date().getTime() / 1000);
                }
                else if (who == "from" && this.localTo != "now") {
                    if (this.localTo.search("/") > -1) {
                        var now = Math.floor(new Date(this.localTo).getTime() / 1000);
                    } else {
                        var now = this.to;
                    }
                }
                // in case we have xdays,xmin etc
                if (relative.search("/") == -1 && relative != 'now') {
                    var parsedDigits = parseInt(relative.match(/\d+/g));
                    if (relative.search("y") >= 0) { // time in years
                        timestamp = now - parsedDigits * 31556952;
                    } else if (relative.search("month") >= 0) { // time in months
                        timestamp = now - parsedDigits * 2629746;
                    } else if (relative.search("d") >= 0) { // time in days
                        timestamp = now - parsedDigits * 86400;
                    } else if (relative.search("h") >= 0) { // time in hours
                        timestamp = now - parsedDigits * 3600;
                    } else if (relative.search("m") >= 0 || relative.search("min") >= 0) { // time in mins
                        timestamp = now - parsedDigits * 60;
                    } else { // time in secs
                        timestamp = now - parsedDigits;
                    }
                //in case we have xx/xx/xxxx format
                } else if (relative != 'now') {
                    timestamp = Math.floor(new Date(relative).getTime() / 1000);
                }
                //in all other occusions if any we have set timestamp=relative in the beginning
                return timestamp;
            },

            clearSelectedButton: function() {
                var prevEl = this.querySelector('.range-button[selected="true"]');
                if (prevEl)
                    prevEl.setAttribute("selected", false);
            },

            addNewDate: function() {
                var start = this.$.from.value;
                var end = this.$.to.value;
                var selPickD = this.querySelector('.date-button[selected="true"]');
                var selPickT = this.querySelector('.time-button[selected="true"]');
                var selEl = this.querySelector('.range-button[selected="true"]');
                this.refreshInterval = this.dropdownIntervalSelection;
                var diff, from, to;
                if (typeof this.localTo === "number") {
                    var df = new Date(this.localFrom);
                    var dt = new Date(this.localTo);
                    this.to = dt.getTime() / 1000;
                    this.from = (df.getTime() / 1000);

                } else {
                    this.to = this._relativetoTimestamp(this.localTo, "to");
                    this.from = this._relativetoTimestamp(this.localFrom, "from");
                    console.log(this.to, this.from, "////", this.localTo, this.localFrom)
                }
                if (this.to + (this.to - this.from) <= Math.floor(new Date().getTime() / 1000)) {
                    this.querySelector('#plusButton').removeAttribute("disabled");
                }
            },

            attached: function() {
                // `attached` fires once the element and its parents have been inserted
                // into a document.
                //
                // This is a good place to perform any work related to your element's
                // visual state or active behavior (measuring sizes, beginning animations,
                // loading resources, etc).
            },

            detached: function() {
                // The analog to `attached`, `detached` fires when the element has been
                // removed from a document.
                //
                // Use this to clean up anything you did in `attached`.
            },
        });
    </script>
</dom-module>
