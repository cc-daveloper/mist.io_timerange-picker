<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-date-picker/paper-date-picker.html">
<link rel="import" href="../paper-time-picker/paper-time-picker.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/editor-icons.html">


<!--
@demo demo/index.html
@hero hero.svg
-->

<dom-module id="timerange-picker">
    <template>
    <style>
      :host {
        display: flex;
        box-sizing: border-box;
        align-items: center;
      }
      paper-button#currenttimerange {
        background-color: #eee;
        text-transform: none;
      }
      paper-icon-button {
        padding: 0.7em 0.57em;
      }
      paper-icon-button[disabled] {
        opacity: 0.32;
      }
      .time-input paper-icon-button {
        align-self: flex-end;
      }
      .time-input {
        vertical-align: baseline; 
      }
      .buttons {
        justify-content: flex-end;
      }
      #timerange {
        margin-right: 16px;
      }
      #quickrange {
        margin: 0 16px 32px 16px;
      }
      paper-dialog h3 {
        margin-top: 0;
        margin-bottom: 0;
      }
      hr {
        margin: 0;
      }
      paper-item {
        padding: 4px;
        font-size: 14px;
        min-height: auto;
        cursor: pointer;
      }
    </style>
    <paper-icon-button on-tap="minusDuration" icon="icons:chevron-left"></paper-icon-button>
    <paper-button id="currenttimerange" toggles active="{{mainDialogOpen}}">{{durationText}}</paper-button>
    <paper-icon-button id="plusButton" disabled="true" on-tap="plusDuration" icon="icons:chevron-right"></paper-icon-button>

    <paper-dialog opened="{{mainDialogOpen}}" id="dialog" modal class="paper-time-picker-dialog">
        <div class="layout horizontal">
          <div id="timerange">
              <h3>Time Range</h3>
              <div class="layout horizontal time-input">
                  <paper-input class="flex" id="from" label="From" value="{{innerFrom}}" on-tap="clearSelectedButton"></paper-input>
                  <paper-icon-button class="from" toggles active="{{fromDialogOpen}}" icon="editor:insert-invitation"></paper-icon-button>
              </div>
              <div class="layout horizontal time-input">
                  <paper-input class="flex" id="to" label="To" value="{{innerTo}}" on-tap="clearSelectedButton"></paper-input>
                  <paper-icon-button class="to" toggles active="{{toDialogOpen}}" icon="editor:insert-invitation"></paper-icon-button>
              </div>
          </div>
          <div id="quickrange">
              <h3>Quick Ranges</h3>
              <div id="listbox" role="listbox">
                  <template is="dom-repeat" items="[[lastxDate]]" as="item">
                      <paper-item id="range" class$="range-button" from$="[[item.from]]" to$="[[item.to]]" type$="[[item.type]]" on-tap="computeDuration">[[item.text]]</paper-item>
                  </template>
                </div>
            </div>
        </div>
        <hr/>
        <div class="layout horizontal buttons">
            <paper-button dialog-dismiss>Cancel</paper-button>
            <paper-button dialog-confirm on-tap="addNewDate">Apply</paper-button>
        </div>
    </paper-dialog>
    <paper-dialog id="datetime" opened="{{fromDialogOpen}}">
        <h2>Select from datetime</h2>
        <div>
            <paper-date-picker id="pickDateFrom" class="date-button"></paper-date-picker>
            <paper-time-picker id="pickTimeFrom" class="time-button"></paper-time-picker>
        </div>
        <div class="pick-buttons">
            <paper-button dialog-confirm on-tap="applyFrom">Apply</paper-button>
            <paper-button dialog-dismiss>Cancel</paper-button>
        </div>
    </paper-dialog>
    <paper-dialog id="datetime" opened="{{toDialogOpen}}">
        <h2>Select to datetime</h2>
        <div>
            <paper-date-picker id="pickDateTo" class="date-button"></paper-date-picker>
            <paper-time-picker id="pickTimeTo" class="time-button"></paper-time-picker>
        </div>
        <div class="pick-buttons">
            <paper-button dialog-confirm on-tap="applyTo">Apply</paper-button>
            <paper-button dialog-dismiss>Cancel</paper-button>
        </div>
    </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'timerange-picker',

            properties: {
                mainDialogOpen: Boolean,
                fromDialogOpen: Boolean,
                toDialogOpen: Boolean,
                onApply: Boolean,
                lastxDate: Array,
                diff: {
                    type: Number,
                    value: 600000
                },
                endOfDiff: {
                    type: Date
                },
                innerFrom: {
                    type: String,
                    value: '-10min'
                },
                innerTo: {
                    type: String,
                    value: 'now'
                },
                from: {
                    type: String,
                    notify: true
                },
                to: {
                    type: String,
                    notify: true
                },
                durationText: {
                    type: String,
                    value: '-10min - now'
                },
                autoRefresh: {
                    type: Boolean,
                }
            },

            ready: function() {
                this.endOfDiff = new Date();
                this.lastxDate = [{
                    from: 5,
                    to: "now",
                    type: "minutes",
                    text: "Last 5 minutes"
                }, {
                    from: 30,
                    to: "now",
                    type: "minutes",
                    text: "Last 30 minutes"
                }, {
                    from: 60,
                    to: "now",
                    type: "minutes",
                    text: "Last 1 hour"
                }, {
                    from: 3,
                    to: "now",
                    type: "hours",
                    text: "Last 3 hours"
                }, {
                    from: 7,
                    to: "now",
                    type: "days",
                    text: "Last 7 days"
                }, {
                    from: 30,
                    to: "now",
                    type: "days",
                    text: "Last 30 days"
                }, {
                    from: 1,
                    to: "now",
                    type: "year",
                    text: "Last year"
                }];
            },

            applyFrom: function() {
                var dateFrom = this.querySelector('#pickDateFrom'),
                    timeFrom = this.querySelector('#pickTimeFrom');
                this.innerFrom = moment(dateFrom.date).format('MM/DD/YYYY');
                this.innerFrom += " " + moment(timeFrom.time.toString(), "hh:mm A").format('HH:mm');
            },

            applyTo: function() {
                var dateTo = this.querySelector('#pickDateTo'),
                    timeTo = this.querySelector('#pickTimeTo');
                this.innerTo = moment(dateTo.date).format('MM/DD/YYYY');
                this.innerTo += " " + moment(timeTo.time.toString(), "hh:mm A").format('HH:mm');
            },

            computeDuration: function(e) {
                var el = e.srcElement;
                var diff = 0;
                var prevEl = this.querySelector('.range-button[selected="true"]');
                if (prevEl)
                    prevEl.setAttribute("selected", false);
                el.setAttribute("selected", true);
                var from = el.attributes.from.value;
                var to = el.attributes.to.value;
                var val = el.attributes.type.value;
                var newDate = new Date();
                switch (val) {
                    case "days":
                        //alternatively for all
                        //moment(new Date(pastDays)).format('MM/DD/YYYY HH:mm');
                        //var pastDays = newDate.setDate(newDate.getDate() - from);
                        this.innerFrom = -from + "d";
                        this.diff = from * 86400000;
                        break;
                    case "hours":
                        this.innerFrom = -from + "h";
                        this.diff = from * 3600000;
                        break;
                    case "year":
                        this.innerFrom = -from + "y";
                        this.diff = from * 31556952000;
                        break;
                    case "minutes":
                        this.innerFrom = -from + "min";
                        this.diff = from * 60000;
                        break;
                }
                this.innerTo = "now";
                this.querySelector('#plusButton').setAttribute("disabled", "true");
            },
            minusDuration: function() {
                var diff;
                var from = this.from;
                var to = this.to;
                if (this.innerTo == "now" || this.to == "now") {
                    diff = this.diff;
                    to = Math.floor(new Date().getTime() / 1000);
                    from = to - this.diff / 1000;
                } else {
                    diff = this.to * 1000 - this.from * 1000;
                    this.diff = diff;
                }
                this.querySelector('#plusButton').removeAttribute("disabled");
                var start = new Date((from * 1000) - diff);
                var end = new Date((to * 1000) - diff);
                this.durationText = moment(start).format('MM/DD/YYYY HH:mm') + " - " + moment(end).format('MM/DD/YYYY HH:mm');
                this.innerTo = moment(end).format('MM/DD/YYYY HH:mm');
                this.innerFrom = moment(start).format('MM/DD/YYYY HH:mm');
                this.to = Math.floor(end.getTime() / 1000);
                this.from = Math.floor(start.getTime() / 1000);
            },
            plusDuration: function() {
                var diff = this.to * 1000 - this.from * 1000;
                var start = new Date((this.from * 1000 + diff));
                var end = new Date((this.to * 1000 + diff));
                this.durationText = moment(start).format('MM/DD/YYYY HH:mm') + " - " + moment(end).format('MM/DD/YYYY HH:mm');
                if (new Date((this.from * 1000 + diff * 3)) >= new Date()) {
                    this.querySelector('#plusButton').setAttribute("disabled", "true");
                    this.to = "now"
                } else {
                    this.to = Math.floor(end.getTime() / 1000);
                }
                this.innerTo = moment(end).format('MM/DD/YYYY HH:mm');
                this.innerFrom = moment(start).format('MM/DD/YYYY HH:mm');
                this.from = Math.floor(start.getTime() / 1000);
            },
            clearSelectedButton: function() {
                var prevEl = this.querySelector('.range-button[selected="true"]');
                if (prevEl)
                    prevEl.setAttribute("selected", false);
            },
            addNewDate: function() {
                var start = this.$.from.value;
                var end = this.$.to.value;
                var date = this.$.pickDateFrom.value;
                var time = this.$.pickTimeFrom.value;
                var date2 = this.$.pickDateTo.value;
                var time2 = this.$.pickTimeTo.value;
                var selPickD = this.querySelector('.date-button[selected="true"]');
                var selPickT = this.querySelector('.time-button[selected="true"]');
                var selEl = this.querySelector('.range-button[selected="true"]');
                if (selEl) {
                    this.durationText = selEl.innerText;
                } else if (selPickD) {
                    this.durationText = selPickD.innerText;
                } else if (selPickT) {
                    this.durationText = selPickT.innerText;
                } else {
                    this.datetime = start + "-" + end;
                    this.durationText = this.datetime;
                }
                if (this.innerTo != "now") {
                    var df = new Date(this.innerFrom);
                    var dt = new Date(this.innerTo);
                    // we use this because we update the graph when ONLY "from" changes value not "To". if we trigger the change with "From" AND "To" there would be double requests etc.
                    //so in case we change only "To" nothing would have happened
                    var fromTrigger = 0;
                    if (this.from == new Date(this.innerFrom).getTime() / 1000) {
                        fromTrigger = 1;
                    }
                    this.to = dt.getTime() / 1000;
                    this.from = (df.getTime() / 1000) + fromTrigger;
                } else {
                    this.to = this.innerTo;
                    this.from = this.innerFrom;
                }
            },
            attached: function() {
                // `attached` fires once the element and its parents have been inserted
                // into a document.
                //
                // This is a good place to perform any work related to your element's
                // visual state or active behavior (measuring sizes, beginning animations,
                // loading resources, etc).
            },

            detached: function() {
                // The analog to `attached`, `detached` fires when the element has been
                // removed from a document.
                //
                // Use this to clean up anything you did in `attached`.
            },
        });
    </script>
</dom-module>
